<!DOCTYPE html>
<html>
<head>
    <title>Toronto Exposed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #0a0a0c; font-family: 'Space Grotesk', 'Segoe UI', sans-serif; color: #ddd; }
        #map { height: 100vh; width: 100vw; }

        /* HEADER */
        .header {
            position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
            background: linear-gradient(180deg, rgba(8,8,12,0.98) 0%, rgba(8,8,12,0.8) 70%, transparent 100%);
            padding: 15px 25px; display: flex; align-items: center; gap: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .header h1 {
            margin: 0; font-size: 24px; font-weight: 700; letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 0%, #888 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header h1 span {
            font-weight: 400; font-size: 12px; letter-spacing: 2px;
            background: linear-gradient(135deg, #ff4444 0%, #ff8844 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: block; text-transform: uppercase; margin-top: 2px;
        }

        /* STATS BAR */
        .stats {
            display: flex; gap: 12px; margin-left: auto;
        }
        .stat {
            background: rgba(255,255,255,0.03); padding: 10px 18px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .stat-num { font-size: 20px; font-weight: 700; color: #fff; }
        .stat-label { font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; }

        /* LAYER PANEL */
        .layer-panel {
            position: absolute; top: 80px; left: 20px; z-index: 1000;
            background: rgba(12,12,16,0.95); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 15px; width: 220px;
            backdrop-filter: blur(20px);
        }
        .layer-panel-title {
            font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        /* VIEW MODE */
        .view-toggle {
            display: flex; gap: 5px;
        }
        .view-btn {
            flex: 1; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            color: #888; padding: 8px; cursor: pointer; border-radius: 6px;
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
        }
        .view-btn:hover { background: rgba(255,255,255,0.06); color: #fff; }
        .view-btn.active { background: linear-gradient(135deg, #ff4444, #ff8844); border-color: transparent; color: #fff; }

        /* HALL OF SHAME SIDEBAR */
        .shame-panel {
            position: absolute; top: 70px; right: 20px; z-index: 1000;
            background: rgba(12,12,15,0.97); border: 1px solid #2a2a35;
            width: 320px; max-height: calc(100vh - 100px); overflow: hidden;
            border-radius: 10px; box-shadow: 0 10px 50px rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        .shame-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 18px; text-align: center; border-bottom: 1px solid #2a2a35;
        }
        .shame-header h2 {
            margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 3px;
            color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .shame-header h2::before { content: "üíÄ"; }
        .shame-header h2::after { content: "üíÄ"; }
        .shame-header small { color: #666; font-size: 10px; display: block; margin-top: 5px; }

        .shame-list {
            max-height: calc(100vh - 200px); overflow-y: auto; padding: 10px;
        }
        .shame-item {
            background: linear-gradient(135deg, #1a1a22 0%, #151518 100%);
            margin-bottom: 8px; padding: 12px;
            border-radius: 8px; border: 1px solid #2a2a35;
            cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .shame-item::before {
            content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
            background: linear-gradient(180deg, #ff3333, #ff8800);
        }
        .shame-item:hover {
            background: linear-gradient(135deg, #252530 0%, #1a1a22 100%);
            transform: translateX(5px);
            border-color: #444;
        }
        .shame-rank {
            display: inline-block; width: 26px; height: 26px;
            background: #2a2a35; border-radius: 50%; text-align: center;
            line-height: 26px; font-weight: bold; font-size: 11px; margin-right: 10px;
            color: #888;
        }
        .shame-rank.gold {
            background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000;
            box-shadow: 0 0 15px rgba(255,215,0,0.4);
        }
        .shame-rank.silver {
            background: linear-gradient(135deg, #e0e0e0, #a0a0a0); color: #000;
            box-shadow: 0 0 10px rgba(200,200,200,0.3);
        }
        .shame-rank.bronze {
            background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff;
            box-shadow: 0 0 10px rgba(205,127,50,0.3);
        }
        .shame-name { font-weight: bold; font-size: 13px; color: #eee; }
        .shame-address { font-size: 10px; color: #666; margin-top: 4px; }
        .shame-badges { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
        .shame-badge {
            font-size: 9px; padding: 4px 8px; border-radius: 4px;
            background: #2a2a35; color: #aaa; border: 1px solid #333;
        }
        .shame-badge.rodent { background: rgba(255,51,51,0.2); color: #ff6666; border-color: #ff3333; }
        .shame-badge.insect { background: rgba(255,136,0,0.2); color: #ffaa44; border-color: #ff8800; }
        .shame-badge.temp { background: rgba(255,102,0,0.2); color: #ff9944; border-color: #ff6600; }
        .shame-badge.contam { background: rgba(204,204,0,0.2); color: #dddd44; border-color: #aaaa00; }
        .shame-badge.sewage { background: rgba(170,0,255,0.2); color: #cc66ff; border-color: #aa00ff; }
        .shame-badge.hygiene { background: rgba(0,204,255,0.2); color: #44ddff; border-color: #00ccff; }
        .shame-count {
            float: right; font-size: 22px; font-weight: bold;
            color: #fff; opacity: 0.9;
            text-shadow: 0 0 20px rgba(255,100,100,0.5);
        }

        /* LEGEND */
        .legend {
            position: absolute; bottom: 20px; left: 20px; z-index: 1000;
            background: rgba(20,20,20,0.95); padding: 12px 15px; border-radius: 5px;
        }
        .legend-title { font-size: 10px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin: 5px 0; font-size: 11px; }
        .legend-emoji { font-size: 16px; width: 20px; text-align: center; }

        /* Cluster styling */
        .marker-cluster {
            background: rgba(255,68,68,0.6) !important;
        }
        .marker-cluster div {
            background: rgba(255,68,68,0.9) !important;
            color: #fff !important;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
        }
        .marker-cluster-small {
            background: rgba(255,136,68,0.6) !important;
        }
        .marker-cluster-small div {
            background: rgba(255,136,68,0.9) !important;
        }
        .marker-cluster-medium {
            background: rgba(255,68,68,0.6) !important;
        }
        .marker-cluster-medium div {
            background: rgba(255,68,68,0.9) !important;
        }
        .marker-cluster-large {
            background: rgba(200,0,0,0.6) !important;
        }
        .marker-cluster-large div {
            background: rgba(200,0,0,0.9) !important;
        }

        /* Scrollbar */
        .shame-list::-webkit-scrollbar { width: 5px; }
        .shame-list::-webkit-scrollbar-track { background: #1a1a22; }
        .shame-list::-webkit-scrollbar-thumb { background: #3a3a45; border-radius: 3px; }
        .shame-list::-webkit-scrollbar-thumb:hover { background: #4a4a55; }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <h1>TORONTO EXPOSED <span>What they don't want you to see</span></h1>
    <div class="stats">
        <div class="stat">
            <div class="stat-num" id="total-count">0</div>
            <div class="stat-label">Total Violations</div>
        </div>
        <div class="stat">
            <div class="stat-num" id="venue-count">0</div>
            <div class="stat-label">Venues</div>
        </div>
    </div>
</div>

<!-- LAYER PANEL -->
<div class="layer-panel">
    <div class="layer-panel-title">View Mode</div>
    <div class="view-toggle">
        <button class="view-btn active" id="btn-markers">Dots</button>
        <button class="view-btn" id="btn-heat">Heat</button>
        <button class="view-btn" id="btn-both">Both</button>
    </div>
</div>

<!-- INSIGHTS PANEL -->
<div class="shame-panel">
    <div class="shame-header">
        <h2>Hall of Shame</h2>
        <small>Worst offenders by violation count</small>
    </div>
    <div class="shame-list" id="shame-list"></div>
</div>

<!-- LEGEND -->
<div class="legend">
    <div class="legend-title">Food Violations</div>
    <div class="legend-item"><span class="legend-emoji">üêÄ</span> Rodent</div>
    <div class="legend-item"><span class="legend-emoji">ü™≥</span> Insect</div>
    <div class="legend-item"><span class="legend-emoji">üå°Ô∏è</span> Temperature</div>
    <div class="legend-item"><span class="legend-emoji">‚ò£Ô∏è</span> Contamination</div>
    <div class="legend-item"><span class="legend-emoji">üí©</span> Sewage</div>
    <div class="legend-item"><span class="legend-emoji">üßº</span> Hygiene</div>
    <div class="legend-item"><span class="legend-emoji">‚ö†Ô∏è</span> General</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    // Initialize Map
    var map = L.map('map').setView([43.6532, -79.3832], 12);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap', maxZoom: 19
    }).addTo(map);

    // Emoji & Color Maps
    var emojiMap = { 'R': 'üêÄ', 'B': 'ü™≥', 'T': 'üå°Ô∏è', 'X': '‚ò£Ô∏è', 'S': 'üí©', 'H': 'üßº', '!': '‚ö†Ô∏è' };
    var colorMap = { 'R': '#ff3333', 'B': '#ff8800', 'T': '#ff6600', 'X': '#ffff00', 'S': '#aa00ff', 'H': '#00ccff', '!': '#777' };

    // Layers
    var markers = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 16
    });
    var heatLayer = null;
    var viewMode = 'markers';

    // Load Data
    fetch('data_food.json')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load data');
            return response.json();
        })
        .then(function(data) {
            console.log('Loaded ' + data.length + ' records');
            document.getElementById('total-count').innerText = data.length;

            var heatPoints = [];
            var venueMap = {};

            data.forEach(function(item) {
                if (!item.lat || !item.lon) return;

                var emoji = emojiMap[item.code] || 'üìç';
                var color = colorMap[item.code] || '#888';

                // Heat point
                var intensity = { 'R': 1.0, 'X': 0.95, 'T': 0.9, 'B': 0.8, 'S': 0.7, 'H': 0.5 }[item.code] || 0.4;
                heatPoints.push([item.lat, item.lon, intensity]);

                // Marker
                var icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="font-size:22px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.9));">' + emoji + '</div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                var popup = '<b>' + item.name + '</b><br>' +
                    '<span style="background:' + color + '; padding:2px 8px; color:#fff; border-radius:3px; font-size:10px;">' + item.hazard + '</span><br>' +
                    '<small>' + item.address + '</small><br>' +
                    '<small style="color:#888;">' + (item.date || '') + '</small>';

                L.marker([item.lat, item.lon], { icon: icon }).bindPopup(popup).addTo(markers);

                // Group by venue
                var key = (item.name || '') + '|' + (item.address || '');
                if (!venueMap[key]) {
                    venueMap[key] = { name: item.name, address: item.address, lat: item.lat, lon: item.lon, violations: [], codes: {} };
                }
                venueMap[key].violations.push(item);
                venueMap[key].codes[item.code] = true;
            });

            // Heat layer
            heatLayer = L.heatLayer(heatPoints, {
                radius: 25, blur: 20, maxZoom: 15, max: 1.0,
                gradient: { 0.0: '#000033', 0.2: '#0000aa', 0.4: '#6600cc', 0.6: '#ff3300', 0.8: '#ff6600', 1.0: '#ffff00' }
            });

            // Add markers to map
            markers.addTo(map);

            // Build shame list
            var venues = Object.values(venueMap);
            document.getElementById('venue-count').innerText = venues.length;
            buildShameList(venues);
        })
        .catch(function(error) {
            console.error('Error:', error);
            document.getElementById('total-count').innerText = 'ERR';
        });

    function buildShameList(venues) {
        venues.sort(function(a, b) { return b.violations.length - a.violations.length; });
        var shameList = document.getElementById('shame-list');
        shameList.innerHTML = '';

        venues.slice(0, 15).forEach(function(venue, index) {
            var rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';

            var badges = '';
            var codeClasses = { 'R': 'rodent', 'B': 'insect', 'T': 'temp', 'X': 'contam', 'S': 'sewage', 'H': 'hygiene' };
            Object.keys(venue.codes).forEach(function(code) {
                var emoji = emojiMap[code] || '';
                var className = codeClasses[code] || '';
                if (className) badges += '<span class="shame-badge ' + className + '">' + emoji + '</span>';
            });

            var item = document.createElement('div');
            item.className = 'shame-item';
            item.innerHTML =
                '<span class="shame-count">' + venue.violations.length + '</span>' +
                '<span class="shame-rank ' + rankClass + '">' + (index + 1) + '</span>' +
                '<span class="shame-name">' + (venue.name || 'Unknown') + '</span>' +
                '<div class="shame-address">' + (venue.address || '') + '</div>' +
                '<div class="shame-badges">' + badges + '</div>';
            item.onclick = function() { map.flyTo([venue.lat, venue.lon], 16); };
            shameList.appendChild(item);
        });
    }

    function updateView() {
        if (viewMode === 'markers' || viewMode === 'both') {
            markers.addTo(map);
        } else {
            map.removeLayer(markers);
        }
        if (heatLayer) {
            if (viewMode === 'heat' || viewMode === 'both') {
                heatLayer.addTo(map);
            } else {
                map.removeLayer(heatLayer);
            }
        }
        document.querySelectorAll('.view-btn').forEach(function(b) { b.classList.remove('active'); });
        document.getElementById('btn-' + viewMode).classList.add('active');
    }

    document.getElementById('btn-markers').onclick = function() { viewMode = 'markers'; updateView(); };
    document.getElementById('btn-heat').onclick = function() { viewMode = 'heat'; updateView(); };
    document.getElementById('btn-both').onclick = function() { viewMode = 'both'; updateView(); };
</script>
</body>
</html>
